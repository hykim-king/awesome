<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.pcwk.ehr.mapper.ArticleMapper">

       <!-- 어드민 기사 관리 카테고리 -->
        <sql id="category_label_sql">
		    CASE CATEGORY
		      WHEN 10 THEN '정치'
		      WHEN 20 THEN '경제'
		      WHEN 30 THEN '사회/문화'
		      WHEN 40 THEN '스포츠'
		      WHEN 50 THEN '연예'
		      WHEN 60 THEN 'IT/과학'
		      ELSE '-'
		    END
		  </sql>
		
		
   <!-- 별칭 A를 쓰는 버전 (별칭 있는 쿼리에서만 사용) -->
			<sql id="category_label_sql_A">
		    CASE A.CATEGORY
		      WHEN 10 THEN '정치'
		      WHEN 20 THEN '경제'
		      WHEN 30 THEN '사회/문화'
		      WHEN 40 THEN '스포츠'
		      WHEN 50 THEN '연예'
		      WHEN 60 THEN 'IT/과학'
		      ELSE '-'
		    END
		  </sql>
        
          
       <!-- resultMap -->
     
		  <resultMap id="ArticleMap" type="com.pcwk.ehr.article.domain.ArticleDTO">
		    <result column="ARTICLE_CODE"   property="articleCode"/>
		    <result column="CATEGORY"       property="category"/>
		    <result column="CATEGORY_LABEL" property="categoryLabel"/>
		    <result column="PRESS"          property="press"/>
		    <result column="TITLE"          property="title"/>
		    <result column="SUMMARY"        property="summary"/>
		    <result column="URL"            property="url"/>
		    <result column="PUBLIC_DT"      property="publicDt"/>
		    <result column="VIEWS"          property="views"/>
		    <result column="REG_DT"         property="regDt"/>
		    <result column="MOD_DT"         property="modDt"/>
		  </resultMap>
       


	<delete id="deleteAll">
		DELETE FROM article
	</delete>
	
	
        <delete id="deleteMany" parameterType="list">
	  DELETE FROM ARTICLE
	  WHERE ARTICLE_CODE IN
	  <foreach collection="ids" item="id" open="(" separator="," close=")">
	    #{id}
	  </foreach>
	</delete>
        
	
	
	

	<update id="updateReadCnt"
		parameterType="com.pcwk.ehr.article.domain.ArticleDTO">
		UPDATE article
		SET
		  views = NVL(views,0)+1
		WHERE
		  ARTICLE_CODE = #{articleCode}
	</update>

	<select id="getCountAll" resultType="java.lang.Integer">
		SELECT COUNT(*) FROM article
	</select>
	
	
	
	
	<select id="getCount"
        parameterType="com.pcwk.ehr.article.domain.ArticleSearchDTO"
        resultType="int">
	  SELECT COUNT(1)
	  FROM ARTICLE
	  WHERE 1=1
	  <if test="searchDiv != null and searchDiv != '' and searchWord != null and searchWord != ''">
	    <choose>
	      <when test="searchDiv == '10'">
	        AND TITLE   LIKE '%' || #{searchWord} || '%'
	      </when>
	      <when test="searchDiv == '20'">
	        AND SUMMARY LIKE '%' || #{searchWord} || '%'
	      </when>
	      <when test="searchDiv == '30'">
	        AND PRESS   LIKE '%' || #{searchWord} || '%'
	      </when>
	    </choose>
	  </if>
	
	  <if test="category != null and category != 0">
	    AND CATEGORY = #{category}
	  </if>
	
	  <if test="dateFilter != null and dateFilter != ''">
	    AND TRUNC(PUBLIC_DT) = TO_DATE(#{dateFilter}, 'YYYY-MM-DD')
	  </if>
	</select>

	<insert id="doSave"
		parameterType="com.pcwk.ehr.article.domain.ArticleDTO"
		useGeneratedKeys="true" keyProperty="articleCode">
		<selectKey keyProperty="articleCode" resultType="long"
			order="BEFORE">
			SELECT ar_seq.NEXTVAL FROM dual
		</selectKey>
		INSERT INTO ARTICLE (
		  ARTICLE_CODE,
		  CATEGORY,
		  PRESS,
		  TITLE,
		  SUMMARY,
		  URL,
		  PUBLIC_DT,
		  VIEWS,
		  REG_DT,
		  MOD_DT
		  )
		VALUES (
		  #{articleCode},
		  #{category},
		  #{press},
		  #{title},
		  #{summary},
		  #{url},
		  #{publicDt},
		  #{views},
		  SYSDATE,
		  SYSDATE
		)
	</insert>

	<!-- 단건 삭제 -->
	<delete id="doDelete" parameterType="long">
		DELETE FROM article
		WHERE article_code = #{articleCode}
	</delete>

	<!-- 단건 조회 (기사 코드로 조회) -->
	<select id="doSelectOne" parameterType="long"
		resultType="com.pcwk.ehr.article.domain.ArticleDTO">
		SELECT
			ARTICLE_CODE,
			CATEGORY,
			PRESS,
			TITLE,
			SUMMARY,
			URL,
			PUBLIC_DT,
			VIEWS,
			REG_DT,
			MOD_DT
			FROM ARTICLE
		WHERE ARTICLE_CODE = #{articleCode}
	</select>

    <select id="doRetrieve"
          parameterType="com.pcwk.ehr.article.domain.ArticleSearchDTO"
          resultType="com.pcwk.ehr.article.domain.ArticleDTO">
    SELECT *
    FROM (
      SELECT A.*, ROWNUM RN
      FROM (
        SELECT
          ARTICLE_CODE, CATEGORY, 
          <include refid="category_label_sql"/> AS CATEGORY_LABEL,
          PRESS, TITLE, SUMMARY, URL,
          PUBLIC_DT, VIEWS, REG_DT, MOD_DT
        FROM ARTICLE
        WHERE 1=1
        <if test="searchDiv != null and searchDiv != '' and searchWord != null and searchWord != ''">
          <choose>
            <when test="searchDiv == '10'">AND TITLE   LIKE '%' || #{searchWord} || '%'</when>
            <when test="searchDiv == '20'">AND SUMMARY LIKE '%' || #{searchWord} || '%'</when>
            <when test="searchDiv == '30'">AND PRESS   LIKE '%' || #{searchWord} || '%'</when>
          </choose>
        </if>
        <if test="category != null and category != 0">
          AND CATEGORY = #{category}
        </if>
        <if test="dateFilter != null and dateFilter != ''">
          AND TRUNC(PUBLIC_DT) = TO_DATE(#{dateFilter}, 'YYYY-MM-DD')
        </if>
        ORDER BY REG_DT DESC
      ) A
    )
    WHERE RN BETWEEN #{startRow} AND #{endRow}
    </select> 
  
  <!-- =========================================================
       관리자 목록(예시) : selectPage
       - 별칭 A 사용 → category_label_sql_A 포함
       ========================================================= -->
  <select id="selectPage" resultMap="ArticleMap"
        parameterType="com.pcwk.ehr.article.domain.ArticleSearchDTO">
  SELECT
    A.ARTICLE_CODE,
    A.CATEGORY,
    ( <include refid="category_label_sql_A"/> ) AS CATEGORY_LABEL,
    A.TITLE,
    A.REG_DT
  FROM ARTICLE A
</select>

    
    
  
  
         <!--   가민경 메인페이지 사용 8/25 -->
          <!-- 최근  클릭수 기준 Top1 (최소 클릭수 추가) -->
         <select id="findTopByCategoryWithinDaysWithMin"
                 parameterType="map"
                 resultType="com.pcwk.ehr.article.domain.ArticleDTO">
           SELECT * FROM (
              SELECT
                a.article_code AS articleCode,
                a.category     AS category,
                a.title        AS title,
                a.url          AS url,
                a.public_dt    AS publicDt,
                NVL(a.views,0) AS views
              FROM article a
              WHERE a.category = #{category}
                AND a.public_dt >= TRUNC(SYSDATE) - #{windowDays}
              ORDER BY NVL(a.views,0) DESC, a.public_dt DESC
            )
            WHERE ROWNUM = 1
                   </select>
       
       <!--   가민경 메인페이지 사용 8/25 -->
         <!-- fallback용: 해당 카테고리 최신 기사 Top1 -->
         <select id="findLatestByCategory"
                 parameterType="int"
                 resultType="com.pcwk.ehr.article.domain.ArticleDTO">
           SELECT * FROM (
             SELECT 
               a.article_code AS articleCode,
               a.category     AS category,
               <include refid="category_label_sql"/> AS CATEGORY_LABEL, <!-- 카테고리 -->
               a.title        AS title,
               a.url          AS url,
               a.public_dt    AS publicDt,
               NVL(a.views, 0) AS views
             FROM article a
             WHERE a.category = #{category}
             ORDER BY a.public_dt DESC
           )
           WHERE ROWNUM = 1
         </select>
 
  
  
</mapper>

