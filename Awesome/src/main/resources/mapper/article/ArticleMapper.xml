<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.pcwk.ehr.mapper.ArticleMapper">

	<delete id="deleteAll">
		DELETE FROM article
	</delete>

	<update id="updateReadCnt"
		parameterType="com.pcwk.ehr.article.domain.ArticleDTO">
		UPDATE article
		SET
		  views = NVL(views,0)+1
		WHERE
		  ARTICLE_CODE = #{articleCode}
	</update>

	<select id="getCountAll" resultType="java.lang.Integer">
		SELECT COUNT(*) FROM article
	</select>
	
	<select id="getCount"
        parameterType="com.pcwk.ehr.article.domain.ArticleSearchDTO"
        resultType="int">
	  SELECT COUNT(1)
	  FROM ARTICLE
	  WHERE 1=1
	  <if test="searchDiv != null and searchDiv != '' and searchWord != null and searchWord != ''">
	    <choose>
	      <when test="searchDiv == '10'">
	        AND TITLE   LIKE '%' || #{searchWord} || '%'
	      </when>
	      <when test="searchDiv == '20'">
	        AND SUMMARY LIKE '%' || #{searchWord} || '%'
	      </when>
	      <when test="searchDiv == '30'">
	        AND PRESS   LIKE '%' || #{searchWord} || '%'
	      </when>
	    </choose>
	  </if>
	
	  <if test="category != null and category != 0">
	    AND CATEGORY = #{category}
	  </if>
	
	  <if test="dateFilter != null and dateFilter != ''">
	    AND TRUNC(PUBLIC_DT) = TO_DATE(#{dateFilter}, 'YYYY-MM-DD')
	  </if>
	</select>

	<insert id="doSave"
		parameterType="com.pcwk.ehr.article.domain.ArticleDTO"
		useGeneratedKeys="true" keyProperty="articleCode">
		<selectKey keyProperty="articleCode" resultType="long"
			order="BEFORE">
			SELECT ar_seq.NEXTVAL FROM dual
		</selectKey>
		INSERT INTO ARTICLE (
		  ARTICLE_CODE,
		  CATEGORY,
		  PRESS,
		  TITLE,
		  SUMMARY,
		  URL,
		  PUBLIC_DT,
		  VIEWS,
		  REG_DT,
		  MOD_DT
		  )
		VALUES (
		  #{articleCode},
		  #{category},
		  #{press},
		  #{title},
		  #{summary},
		  #{url},
		  #{publicDt},
		  #{views},
		  SYSDATE,
		  SYSDATE
		)
	</insert>

	<!-- 단건 삭제 -->
	<delete id="doDelete" parameterType="long">
		DELETE FROM article
		WHERE article_code = #{articleCode}
	</delete>

	<!-- 단건 조회 (기사 코드로 조회) -->
	<select id="doSelectOne" parameterType="long"
		resultType="com.pcwk.ehr.article.domain.ArticleDTO">
		SELECT
			ARTICLE_CODE,
			CATEGORY,
			PRESS,
			TITLE,
			SUMMARY,
			URL,
			PUBLIC_DT,
			VIEWS,
			REG_DT,
			MOD_DT
			FROM ARTICLE
		WHERE ARTICLE_CODE = #{articleCode}
	</select>

    <select id="doRetrieve"
          parameterType="com.pcwk.ehr.article.domain.ArticleSearchDTO"
          resultType="com.pcwk.ehr.article.domain.ArticleDTO">
    SELECT *
    FROM (
      SELECT A.*, ROWNUM RN
      FROM (
        SELECT
          ARTICLE_CODE, CATEGORY, PRESS, TITLE, SUMMARY, URL,
          PUBLIC_DT, VIEWS, REG_DT, MOD_DT
        FROM ARTICLE
        WHERE 1=1
        <if test="searchDiv != null and searchDiv != '' and searchWord != null and searchWord != ''">
          <choose>
            <when test="searchDiv == '10'">AND TITLE   LIKE '%' || #{searchWord} || '%'</when>
            <when test="searchDiv == '20'">AND SUMMARY LIKE '%' || #{searchWord} || '%'</when>
            <when test="searchDiv == '30'">AND PRESS   LIKE '%' || #{searchWord} || '%'</when>
          </choose>
        </if>
        <if test="category != null and category != 0">
          AND CATEGORY = #{category}
        </if>
        <if test="dateFilter != null and dateFilter != ''">
          AND TRUNC(PUBLIC_DT) = TO_DATE(#{dateFilter}, 'YYYY-MM-DD')
        </if>
        ORDER BY REG_DT DESC
      ) A
    )
    WHERE RN BETWEEN #{startRow} AND #{endRow}
  </select>
  
  
         <!--   가민경 메인페이지 사용 8/25 -->
          <!-- 최근  클릭수 기준 Top1 (최소 클릭수 추가) -->
         <select id="findTopByCategoryWithinDaysWithMin"
                 parameterType="map"
                 resultType="com.pcwk.ehr.article.domain.ArticleDTO">
           SELECT * FROM (
              SELECT
                a.article_code AS articleCode,
                a.category     AS category,
                a.title        AS title,
                a.url          AS url,
                a.public_dt    AS publicDt,
                NVL(a.views,0) AS views
              FROM article a
              WHERE a.category = #{category}
                AND a.public_dt >= TRUNC(SYSDATE) - #{windowDays}
              ORDER BY NVL(a.views,0) DESC, a.public_dt DESC
            )
            WHERE ROWNUM = 1
                   </select>
       
       <!--   가민경 메인페이지 사용 8/25 -->
         <!-- fallback용: 해당 카테고리 최신 기사 Top1 -->
         <select id="findLatestByCategory"
                 parameterType="int"
                 resultType="com.pcwk.ehr.article.domain.ArticleDTO">
           SELECT * FROM (
             SELECT 
               a.article_code AS articleCode,
               a.category     AS category,
               a.title        AS title,
               a.url          AS url,
               a.public_dt    AS publicDt,
               NVL(a.views, 0) AS views
             FROM article a
             WHERE a.category = #{category}
             ORDER BY a.public_dt DESC
           )
           WHERE ROWNUM = 1
         </select>
 
  
  
</mapper>

