<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.pcwk.ehr.mapper.MemberMapper">

  <!-- ====================== 참조 카운트 ====================== -->
  <select id="countQuizByIds" parameterType="list" resultType="int">
    SELECT COUNT(*)
      FROM QUIZ_RESULT
     WHERE USER_ID IN
    <foreach collection="ids" item="id" open="(" separator="," close=")">
      #{id}
    </foreach>
  </select>

  <select id="countReportByUserIds" parameterType="list" resultType="int">
    SELECT COUNT(*) FROM REPORT
     WHERE USER_ID IN
    <foreach collection="ids" item="id" open="(" separator="," close=")">
      #{id}
    </foreach>
  </select>

  <select id="countReportByTargetIds" parameterType="list" resultType="int">
    SELECT COUNT(*) FROM REPORT
     WHERE CT_ID IN
    <foreach collection="ids" item="id" open="(" separator="," close=")">
      #{id}
    </foreach>
  </select>

  <select id="countChatByUserIds" parameterType="list" resultType="int">
    SELECT COUNT(*) FROM CHAT_MESSAGE
     WHERE USER_ID IN
    <foreach collection="ids" item="id" open="(" separator="," close=")">
      #{id}
    </foreach>
  </select>

  <!-- ====================== 자식 삭제 ====================== -->
  <delete id="deleteQuizByUserIds" parameterType="list">
    DELETE FROM QUIZ_RESULT
     WHERE USER_ID IN
    <foreach collection="ids" item="id" open="(" separator="," close=")">
      #{id}
    </foreach>
  </delete>

  <delete id="deleteReportByUserIds" parameterType="list">
    DELETE FROM REPORT
     WHERE USER_ID IN
    <foreach collection="ids" item="id" open="(" separator="," close=")">
      #{id}
    </foreach>
  </delete>

  <delete id="deleteReportByTargetIds" parameterType="list">
    DELETE FROM REPORT
     WHERE CT_ID IN
    <foreach collection="ids" item="id" open="(" separator="," close=")">
      #{id}
    </foreach>
  </delete>

  <delete id="deleteChatByUserIds" parameterType="list">
    DELETE FROM CHAT_MESSAGE
     WHERE USER_ID IN
    <foreach collection="ids" item="id" open="(" separator="," close=")">
      #{id}
    </foreach>
  </delete>

  <!-- ====================== MEMBER 다건 삭제 ====================== -->
  <delete id="deleteMembersByIds" parameterType="list">
    DELETE FROM MEMBER
     WHERE USER_ID IN
    <foreach collection="ids" item="id" open="(" separator="," close=")">
      #{id}
    </foreach>
  </delete>


  <!-- ====================== 관리자 목록/검색/등급 ====================== -->
  <sql id="admin_member_where">
    WHERE 1=1
    <if test="type == 'id' and keyword != null and keyword != ''">
      AND UPPER(USER_ID) LIKE UPPER('%' || #{keyword} || '%')
    </if>
    <if test="type == 'nick' and keyword != null and keyword != ''">
      AND UPPER(NICK_NM) LIKE UPPER('%' || #{keyword} || '%')
    </if>
    <if test="grade != null">
      AND USER_GRADE_CD = #{grade}
    </if>
  </sql>


    <!-- 아이디 중복체크 -->
    <select id="existsById" parameterType="string" resultType="int">
     SELECT COUNT(1)
     FROM MEMBER
     WHERE UPPER(USER_ID) = UPPER(TRIM(#{userId}))
    </select>
    
    <!-- 닉네임 중복 체크 -->
    <select id="existsByNick" parameterType="string" resultType="int">
	  SELECT COUNT(*) 
	  FROM MEMBER 
	  WHERE NICK_NM = #{nickNm}
	</select>
    
     <!-- kinda 아이디로만 사용자 조회 -->
	    <select id="findByUserId" parameterType="string"
	        resultType="com.pcwk.ehr.member.domain.MemberDTO">
			  SELECT USER_ID, PWD, USER_NM, NICK_NM, BIRTH_DT,
			         MAIL_ADDR, EMAIL_AUTH_YN, EMAIL_AUTH_TOKEN, USER_GRADE_CD,
			         REG_DT, MOD_DT
			  FROM MEMBER
			  WHERE USER_ID = #{userId}
	</select>
    
        
        <select id="findUserId" resultType="string">
        SELECT USER_ID
          FROM MEMBER
         WHERE USER_NM = #{userNm}
           AND MAIL_ADDR = #{mailAddr}
         ORDER BY REG_DT DESC
         FETCH FIRST 1 ROW ONLY
         </select>
   
	    <!-- 총 개수 -->
	<select id="countMembersForAdmin" parameterType="map" resultType="int">
	  SELECT COUNT(*) FROM MEMBER
	  WHERE 1=1
	    <if test="type == 'id' and keyword != null and keyword != ''">
	      AND UPPER(USER_ID) LIKE UPPER('%' || #{keyword} || '%')
	    </if>
	    <if test="type == 'nick' and keyword != null and keyword != ''">
	      AND UPPER(NICK_NM) LIKE UPPER('%' || #{keyword} || '%')
	    </if>
	    <if test="grade != null">
	      AND USER_GRADE_CD = #{grade}
	    </if>
	</select>
	
	<!-- 목록 (Oracle 12c+ 기준. 11g면 ROWNUM 방식으로 바꾸세요) -->
	<select id="listMembersForAdmin" parameterType="map"
	        resultType="com.pcwk.ehr.member.domain.MemberDTO">
	  SELECT USER_ID, USER_NM, NICK_NM, MAIL_ADDR, BIRTH_DT,
	         USER_GRADE_CD, EMAIL_AUTH_YN,
	         REG_DT, MOD_DT
	    FROM MEMBER
	   WHERE 1=1
	     <if test="type == 'id' and keyword != null and keyword != ''">
	       AND UPPER(USER_ID) LIKE UPPER('%' || #{keyword} || '%')
	     </if>
	     <if test="type == 'nick' and keyword != null and keyword != ''">
	       AND UPPER(NICK_NM) LIKE UPPER('%' || #{keyword} || '%')
	     </if>
	     <if test="grade != null">
	       AND USER_GRADE_CD = #{grade}
	     </if>
	   ORDER BY REG_DT DESC
	   OFFSET #{offset} ROWS FETCH NEXT #{limit} ROWS ONLY
	</select>
	
	<!-- 비밀번호 변경 -->
    <update id="updatePwdByUserId" parameterType="com.pcwk.ehr.member.domain.MemberDTO">
      UPDATE MEMBER
         SET PWD = #{pwd},
             MOD_DT = SYSDATE
       WHERE USER_ID = #{userId}
    </update>
	
	<!-- 닉네임 변경 -->
    <update id="updateNickNmByUserId" parameterType="com.pcwk.ehr.member.domain.MemberDTO">
      UPDATE MEMBER
         SET NICK_NM = #{nickNm},
             MOD_DT = SYSDATE
       WHERE USER_ID = #{userId}
    </update>
	
	<!-- 등급 변경 -->
	<update id="updateGradeByUserId" parameterType="map">
	  UPDATE MEMBER
	     SET USER_GRADE_CD = #{grade},
	         MOD_DT = SYSDATE
	   WHERE USER_ID = #{userId}
	</update>
	
	<!-- 일괄 삭제 -->
	<delete id="deleteMembersByIds" parameterType="list">
	  DELETE FROM MEMBER
	   WHERE USER_ID IN
	   <foreach item="id" collection="list" open="(" separator="," close=")">
	     #{id}
	   </foreach>
	</delete>


  <select id="countMembersForAdmin" resultType="int">
    SELECT COUNT(*) FROM MEMBER
    <include refid="admin_member_where"/>
  </select>

  <select id="listMembersForAdmin"
          resultType="com.pcwk.ehr.member.domain.MemberDTO">
    SELECT USER_ID, USER_NM, NICK_NM, MAIL_ADDR, BIRTH_DT,
           USER_GRADE_CD, EMAIL_AUTH_YN, REG_DT, MOD_DT
      FROM MEMBER
    <include refid="admin_member_where"/>
    ORDER BY REG_DT DESC
    OFFSET #{offset} ROWS FETCH NEXT #{limit} ROWS ONLY
  </select>

  <update id="updateGradeByUserId">
    UPDATE MEMBER
       SET USER_GRADE_CD = #{grade},
           MOD_DT        = SYSDATE
     WHERE USER_ID      = #{userId}
  </update>
</mapper>
